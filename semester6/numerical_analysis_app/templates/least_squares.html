{% extends "base.html" %}

{% block content %}
<section class="method-section">
    <h2>Least Squares and Curve Fitting</h2>

    <form method="POST">
        <div class="form-group">
            <label for="x_values">X values (comma separated):</label>
            <input type="text" id="x_values" name="x_values" required
                value="{% if show_result %}{{ ','.join(x_values|map('string')) }}{% endif %}"
                placeholder="e.g., 1,2,3,4,5">
        </div>

        <div class="form-group">
            <label for="y_values">Y values (comma separated):</label>
            <input type="text" id="y_values" name="y_values" required
                value="{% if show_result %}{{ ','.join(y_values|map('string')) }}{% endif %}"
                placeholder="e.g., 1.2,1.9,3.2,4.1,5.0">
        </div>

        <div class="form-group">
            <label>Method:</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="method" value="linear" {% if not show_result or method=='linear'
                        %}checked{% endif %}>
                    Linear Regression (y = ax + b)
                </label>
                <label>
                    <input type="radio" name="method" value="polynomial" {% if show_result and method=='polynomial'
                        %}checked{% endif %}>
                    Polynomial Fit
                </label>
            </div>
        </div>

        <div class="form-group" id="degree-group"
            style="{% if not show_result or method == 'linear' %}display:none{% endif %}">
            <label for="degree">Polynomial degree:</label>
            <input type="number" id="degree" name="degree" min="1" max="10"
                value="{% if show_result and method == 'polynomial' %}2{% else %}1{% endif %}">
        </div>

        <button type="submit">Calculate</button>
    </form>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    {% if show_result %}
    <div class="result-section">
        <h3>Result</h3>

        {% if method == 'polynomial' %}
        <p>Fitted polynomial: <strong>y = {{ polynomial }}</strong></p>
        <h4>Coefficients (highest degree first):</h4>
        <ul>
            {% for coeff in coeffs %}
            <li>{{ coeff }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Linear regression equation: <strong>y = {{ slope }}x + {{ intercept }}</strong></p>
        <h4>Parameters:</h4>
        <ul>
            <li>Slope (a): {{ slope }}</li>
            <li>Intercept (b): {{ intercept }}</li>
        </ul>
        {% endif %}

        <div id="chart-container" style="width: 100%; height: 400px;"></div>

        <h4>MATLAB Code</h4>
        <div class="code-example">
            {% if method == 'polynomial' %}
            <pre>
% Polynomial fitting
x = [{{ x_values|join(',') }}];
y = [{{ y_values|join(',') }}];
degree = {{ degree }};
coefficients = polyfit(x, y, degree);
fitted_poly = poly2str(coefficients, 'x');</pre>
            {% else %}
            <pre>
% Linear regression
x = [{{ x_values|join(',') }}];
y = [{{ y_values|join(',') }}];
A = [x; ones(size(x))]';
params = A \ y';
slope = params(1);
intercept = params(2);</pre>
            {% endif %}
        </div>
    </div>
    {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Show/hide degree input based on method selection
        const methodRadios = document.querySelectorAll('input[name="method"]');
        const degreeGroup = document.getElementById('degree-group');

        methodRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                degreeGroup.style.display = this.value === 'polynomial' ? 'block' : 'none';
            });
        });

        {% if show_result %}
        // Plot the data and fitted curve
        const xValues = {{ x_values| tojson
    }};
    const yValues = {{ y_values| tojson }};
    const xFit = {{ x_fit| tojson }};
    const yFit = {{ y_fit| tojson }};

    const trace1 = {
        x: xValues,
        y: yValues,
        mode: 'markers',
        type: 'scatter',
        name: 'Data Points',
        marker: { size: 10 }
    };

    const trace2 = {
        x: xFit,
        y: yFit,
        mode: 'lines',
        type: 'scatter',
        name: 'Fitted Curve',
        line: { color: 'red', width: 2 }
    };

    const layout = {
        title: 'Least Squares Fit',
        xaxis: { title: 'X values' },
        yaxis: { title: 'Y values' },
        showlegend: true
    };

    Plotly.newPlot('chart-container', [trace1, trace2], layout);
    {% endif %}
    });
</script>

<style>
    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .code-example {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        margin: 1rem 0;
    }

    pre {
        margin: 0;
        font-family: 'Courier New', Courier, monospace;
        line-height: 1.4;
    }
</style>
{% endblock %}